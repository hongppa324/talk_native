plugins {
  id 'com.android.application'
  id 'org.jetbrains.kotlin.android'
  id 'com.facebook.react'
  // ✅ Kotlin 2.0+ 에서는 Compose 컴파일러 플러그인 필요
  id 'org.jetbrains.kotlin.plugin.compose'
}

def projectRoot = rootDir.getAbsoluteFile().getParentFile().getAbsolutePath()

react {
  // Expo의 entryFile/cli/bundle 설정 – 기존 그대로 유지
  entryFile = file(["node", "-e", "require('expo/scripts/resolveAppEntry')", projectRoot, "android", "absolute"].execute(null, rootDir).text.trim())
  reactNativeDir = new File(["node", "--print", "require.resolve('react-native/package.json')"].execute(null, rootDir).text.trim()).getParentFile().getAbsoluteFile()
  hermesCommand = new File(["node", "--print", "require.resolve('react-native/package.json')"].execute(null, rootDir).text.trim()).getParentFile().getAbsolutePath() + "/sdks/hermesc/%OS-BIN%/hermesc"
  codegenDir = new File(["node", "--print", "require.resolve('@react-native/codegen/package.json', { paths: [require.resolve('react-native/package.json')] })"].execute(null, rootDir).text.trim()).getParentFile().getAbsoluteFile()

  enableBundleCompression = (findProperty('android.enableBundleCompression') ?: false).toBoolean()
  // Expo CLI로 번들 – 기존 유지
  cliFile = new File(["node", "--print", "require.resolve('@expo/cli', { paths: [require.resolve('expo/package.json')] })"].execute(null, rootDir).text.trim())
  bundleCommand = "export:embed"

  /* Autolinking */
  autolinkLibrariesWithApp()
}

/** Proguard toggle for release */
def enableProguardInReleaseBuilds = (findProperty('android.enableProguardInReleaseBuilds') ?: false).toBoolean()

/** JSC flavor (used when Hermes disabled) */
def jscFlavor = 'io.github.react-native-community:jsc-android:2026004.+'

android {
  ndkVersion rootProject.ext.ndkVersion
  buildToolsVersion rootProject.ext.buildToolsVersion
  compileSdk rootProject.ext.compileSdkVersion

  namespace 'com.okcanvas.rnnative'

  defaultConfig {
    applicationId 'com.okcanvas.rnnative'
    minSdkVersion rootProject.ext.minSdkVersion
    targetSdkVersion rootProject.ext.targetSdkVersion
    versionCode 1
    versionName "1.0.0"
  }

  signingConfigs {
    debug {
      storeFile file('debug.keystore')
      storePassword 'android'
      keyAlias 'androiddebugkey'
      keyPassword 'android'
    }
  }

  buildTypes {
    debug {
      signingConfig signingConfigs.debug
    }
    release {
      // NOTE: For production, use your own keystore!
      signingConfig signingConfigs.debug
      shrinkResources (findProperty('android.enableShrinkResourcesInReleaseBuilds')?.toBoolean() ?: false)
      minifyEnabled enableProguardInReleaseBuilds
      proguardFiles getDefaultProguardFile("proguard-android.txt"), "proguard-rules.pro"
      crunchPngs (findProperty('android.enablePngCrunchInReleaseBuilds')?.toBoolean() ?: true)
    }
  }

  packagingOptions {
    jniLibs {
      useLegacyPackaging (findProperty('expo.useLegacyPackaging')?.toBoolean() ?: false)
    }
  }

  androidResources {
    ignoreAssetsPattern '!.svn:!.git:!.ds_store:!*.scc:!CVS:!thumbs.db:!picasa.ini:!*~'
  }

  /** ✅ Compose 활성화 */
  buildFeatures {
    compose true
  }

  /** ✅ Kotlin/JVM 17 정렬 */
  compileOptions {
    sourceCompatibility JavaVersion.VERSION_17
    targetCompatibility JavaVersion.VERSION_17
  }
  kotlinOptions {
    jvmTarget = "17"
  }

  /**
   * ⛔️ composeOptions.kotlinCompilerExtensionVersion 는
   * Kotlin 2.0 + compose-plugin 사용 시 지정하지 않습니다.
   * (플러그인이 버전 매칭을 처리)
   */
  // composeOptions {
  //   kotlinCompilerExtensionVersion "1.5.14"
  // }
}

/**
 * gradle.properties 의 static 값들을 android.packagingOptions 에 주입
 * (기존 스크립트 유지)
 */
["pickFirsts", "excludes", "merges", "doNotStrip"].each { prop ->
  def options = (findProperty("android.packagingOptions.$prop") ?: "").split(",");
  for (i in 0..<options.size()) options[i] = options[i].trim();
  options -= ""
  if (options.length > 0) {
    println "android.packagingOptions.$prop += $options ($options.length)"
    options.each {
      android.packagingOptions[prop] += it
    }
  }
}

dependencies {
  // RN android lib (버전은 RN Gradle Plugin이 설정)
  implementation("com.facebook.react:react-android")

  implementation "androidx.recyclerview:recyclerview:1.3.2"
  implementation "com.google.android.material:material:1.12.0"

  /** =========================
   *  ✅ Jetpack Compose (BOM)
   *  ========================= */
  def composeBom = platform("androidx.compose:compose-bom:2024.10.01")
  implementation composeBom
  androidTestImplementation composeBom

  // Core UI / Material3 / Activity
  implementation "androidx.activity:activity-compose:1.9.2"
  implementation "androidx.compose.ui:ui"
  implementation "androidx.compose.ui:ui-text"
  implementation "androidx.compose.foundation:foundation"
  implementation "androidx.compose.material3:material3"
  implementation "androidx.compose.ui:ui-tooling-preview"
  implementation "androidx.compose.material:material-icons-extended"
  debugImplementation "androidx.compose.ui:ui-tooling"

  // (필요 시) runtime 명시 – BOM이 있으면 생략해도 보통 OK
  implementation "androidx.compose.runtime:runtime"

  // Lifecycles (Compose에 권장)
  implementation "androidx.lifecycle:lifecycle-runtime-ktx:2.8.6"

  // 이미지 로딩/뷰어
  implementation("io.coil-kt:coil-compose:2.6.0")
  implementation("com.mxalbert.zoomable:zoomable-android:1.6.0")

  /** =========================
   *  RN 이미지 포맷 옵션 (기존 유지)
   *  ========================= */
  def isGifEnabled = (findProperty('expo.gif.enabled') ?: "") == "true";
  def isWebpEnabled = (findProperty('expo.webp.enabled') ?: "") == "true";
  def isWebpAnimatedEnabled = (findProperty('expo.webp.animated') ?: "") == "true";

  if (isGifEnabled) {
    implementation("com.facebook.fresco:animated-gif:${expoLibs.versions.fresco.get()}")
  }
  if (isWebpEnabled) {
    implementation("com.facebook.fresco:webpsupport:${expoLibs.versions.fresco.get()}")
    if (isWebpAnimatedEnabled) {
      implementation("com.facebook.fresco:animated-webp:${expoLibs.versions.fresco.get()}")
    }
  }

  /** Hermes / JSC 선택 (기존 유지) */
  if (hermesEnabled.toBoolean()) {
    implementation("com.facebook.react:hermes-android")
  } else {
    implementation jscFlavor
  }
}
